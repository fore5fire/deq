apiVersion: v1
kind: Pod
metadata:
  name: {{ template "fullname" . }}-tests-{{ randAlphaNum 8 | lower }}
  labels:
    app: {{ template "name" . }}
    chart: {{ .Chart.Name }}
    chartVersion: {{ .Chart.Version | replace "+" "_" }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
    service: {{ template "name" . }}-tests
  annotations:
    "helm.sh/hook": test-success
spec:
  restartPolicy: Never
  initContainers:
  - name: service-ready
    image: lachlanevenson/k8s-kubectl:v1.9.2
    command:
      - /bin/sh
    args:
      - -c
      - until [ $( kubectl get endpoints -o=go-template --template "{{"{{range .subsets}}{{if .addresses}}ready{{end}}{{end}}"}}" {{ template "fullname" . }} ) ]; do echo waiting for service {{ template "fullname" . }}; sleep 2; done;
  containers:
    - name: {{ .Chart.Name }}
      image: "{{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}"
      imagePullPolicy: {{ .Values.tests.image.pullPolicy }}
      env:
      - name: TEST_TARGET_ENDPOINT
        value: {{ template "fullname" . }}:80
      - name: LOG_LEVEL
        value: {{ .Values.logLevel }}
      resources:
{{ toYaml .Values.tests.resources | indent 12 }}
  {{- if .Values.tests.image.pullSecret }}
  imagePullSecrets:
  - name: {{ .Values.tests.image.pullSecret }}
  {{- end }}
{{- if .Values.nodeSelector }}
  nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
{{- end }}
